---
import { ClientRouter } from "astro:transitions";
import "../styles/global.css";

interface Props {
  title: string;
  description: string;
  lang?: string;
}

const { title, description, lang = "es" } = Astro.props;
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />

    <!-- SEO -->
    <title>{title}</title>
    <meta name="description" content={description} />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="preload"
      as="style"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400;1,700&display=swap"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript>
      <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400;1,700&display=swap"
        rel="stylesheet"
      />
    </noscript>

    <ClientRouter />


  </head>
  <body>
    <!-- Custom Cursor (desktop only) -->
    <div
      id="cursor-dot"
      class="fixed top-0 left-0 w-2 h-2 bg-gold rounded-full pointer-events-none z-[9999] opacity-0 mix-blend-difference"
      aria-hidden="true"
    >
    </div>
    <div
      id="cursor-ring"
      class="fixed top-0 left-0 w-10 h-10 border border-gold/60 rounded-full pointer-events-none z-[9999] opacity-0 mix-blend-difference"
      aria-hidden="true"
    >
    </div>
    <slot />

    <!-- Scripts that need to run on page load and after every transition -->
    <script>
      import { gsap, ScrollTrigger } from "../lib/gsap-init";

      function initRevealAnimations() {
        const prefersReducedMotion = window.matchMedia(
          "(prefers-reduced-motion: reduce)",
        ).matches;
        if (prefersReducedMotion) {
          // Immediately show all reveals if user prefers reduced motion
          document.querySelectorAll(".reveal").forEach((el) => {
            (el as HTMLElement).style.opacity = "1";
            (el as HTMLElement).style.transform = "none";
          });
          return;
        }

        document.querySelectorAll(".reveal").forEach((el) => {
          ScrollTrigger.create({
            trigger: el,
            start: "top 90%",
            once: true,
            onEnter: () => {
              gsap.to(el, {
                opacity: 1,
                y: 0,
                duration: 0.8,
                ease: "power2.out",
                delay: 0.1,
              });
            },
          });
        });
      }

      document.addEventListener("astro:page-load", () => {
        initRevealAnimations();
      });

    </script>

    <!-- Custom Cursor Script -->
    <script>
      import { gsap } from "../lib/gsap-init";

      function initCustomCursor() {
        const dot = document.getElementById("cursor-dot");
        const ring = document.getElementById("cursor-ring");

        if (!dot || !ring) return;

        // Only enable on devices with a fine pointer (mouse/trackpad)
        const hasFinePointer = window.matchMedia("(pointer: fine)").matches;
        if (!hasFinePointer) {
          dot.style.display = "none";
          ring.style.display = "none";
          document.documentElement.style.cursor = "auto";
          return;
        }

        // Hide default cursor
        document.documentElement.style.cursor = "none";

        // Show custom cursor elements
        gsap.set(dot, { opacity: 1 });
        gsap.set(ring, { opacity: 1 });

        // Track mouse position
        let mouseX = 0;
        let mouseY = 0;
        let cursorSettleFrames = 0;

        document.addEventListener("mousemove", (e) => {
          mouseX = e.clientX;
          mouseY = e.clientY;
          cursorSettleFrames = 15;

          // Dot follows instantly
          gsap.set(dot, {
            x: mouseX - 4, // center the 8px dot
            y: mouseY - 4,
          });
        });

        // Ring follows with smooth lerp via GSAP ticker
        gsap.ticker.add(() => {
          if (cursorSettleFrames <= 0) return;
          cursorSettleFrames--;

          const ringX = (gsap.getProperty(ring, "x") as number) || 0;
          const ringY = (gsap.getProperty(ring, "y") as number) || 0;

          const dx = mouseX - 20 - ringX; // center the 40px ring
          const dy = mouseY - 20 - ringY;

          gsap.set(ring, {
            x: ringX + dx * 0.15,
            y: ringY + dy * 0.15,
          });
        });

        // Hover effect: expand ring on interactive elements
        const interactives = document.querySelectorAll(
          "a, button, input, textarea, .vip-card, [role='button']",
        );

        interactives.forEach((el) => {
          el.addEventListener("mouseenter", () => {
            const isMagic = (el as HTMLElement).dataset.cursor === "magic";
            gsap.to(ring, {
              scale: isMagic ? 3 : 1.5,
              borderColor: isMagic
                ? "rgba(212, 175, 55, 0.6)"
                : "rgba(212, 175, 55, 0.3)",
              backgroundColor: isMagic
                ? "rgba(212, 175, 55, 0.3)"
                : "rgba(212, 175, 55, 0.08)",
              duration: isMagic ? 3 : 0.3,
              ease: "power2.out",
            });
            gsap.to(dot, {
              scale: isMagic ? 0 : 0.5,
              duration: isMagic ? 3 : 0.3,
            });
          });

          el.addEventListener("mouseleave", () => {
            gsap.to(ring, {
              scale: 1,
              borderColor: "rgba(212, 175, 55, 0.6)",
              backgroundColor: "transparent",
              duration: 0.3,
              ease: "power2.out",
            });
            gsap.to(dot, { scale: 1, duration: 0.3 });
          });
        });

        // Click pulse effect
        document.addEventListener("mousedown", () => {
          gsap.to(ring, { scale: 0.8, duration: 0.1, ease: "power2.in" });
        });
        document.addEventListener("mouseup", () => {
          gsap.to(ring, {
            scale: 1,
            duration: 0.3,
            ease: "elastic.out(1, 0.3)",
          });
        });

        // Hide cursor when it leaves the window
        document.addEventListener("mouseleave", () => {
          gsap.to([dot, ring], { opacity: 0, duration: 0.2 });
        });
        document.addEventListener("mouseenter", () => {
          gsap.to([dot, ring], { opacity: 1, duration: 0.2 });
        });
      }

      document.addEventListener("astro:page-load", initCustomCursor);
    </script>
  </body>
</html>
