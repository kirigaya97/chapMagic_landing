---
import SectionHeading from "../ui/SectionHeading.astro";
import Button from "../ui/Button.astro";
import Reveal from "../ui/Reveal.astro";

interface Props {
    t: {
        sectionTitle: string;
        nameLabel: string;
        namePlaceholder: string;
        emailLabel: string;
        emailPlaceholder: string;
        messageLabel: string;
        messagePlaceholder: string;
        submitButton: string;
        submitting: string;
        successMessage: string;
        errorMessage: string;
    };
}

const { t } = Astro.props;
---

<section
    id="contact"
    class="py-section-mobile md:py-section bg-obsidian-light px-6"
>
    <div class="max-w-4xl mx-auto">
        <SectionHeading
            title={t.sectionTitle}
            subtitle="Hablemos de tu próximo evento"
        />

        <Reveal>
            <form id="contact-form" class="space-y-6">
                <!-- Honeypot: invisible to humans, bots fill this -->
                <div
                    class="absolute opacity-0 -z-10 h-0 overflow-hidden"
                    aria-hidden="true"
                >
                    <label for="website">Website</label>
                    <input
                        type="text"
                        id="website"
                        name="website"
                        tabindex="-1"
                        autocomplete="off"
                    />
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label
                            for="name"
                            class="block text-sm font-body uppercase tracking-widest text-gold"
                            >{t.nameLabel}</label
                        >
                        <input
                            type="text"
                            id="name"
                            name="name"
                            required
                            placeholder={t.namePlaceholder}
                            class="w-full bg-obsidian border border-smoke p-4 rounded-card text-ivory placeholder:text-smoke focus:outline-none focus:border-gold/50 transition-colors"
                        />
                    </div>
                    <div class="space-y-2">
                        <label
                            for="email"
                            class="block text-sm font-body uppercase tracking-widest text-gold"
                            >{t.emailLabel}</label
                        >
                        <input
                            type="email"
                            id="email"
                            name="email"
                            required
                            placeholder={t.emailPlaceholder}
                            class="w-full bg-obsidian border border-smoke p-4 rounded-card text-ivory placeholder:text-smoke focus:outline-none focus:border-gold/50 transition-colors"
                        />
                    </div>
                </div>

                <div class="space-y-2">
                    <label
                        for="message"
                        class="block text-sm font-body uppercase tracking-widest text-gold"
                        >{t.messageLabel}</label
                    >
                    <textarea
                        id="message"
                        name="message"
                        required
                        rows="5"
                        placeholder={t.messagePlaceholder}
                        class="w-full bg-obsidian border border-smoke p-4 rounded-card text-ivory placeholder:text-smoke focus:outline-none focus:border-gold/50 transition-colors resize-none"
                    ></textarea>
                </div>

                <div class="text-center">
                    <Button
                        type="submit"
                        variant="gold"
                        class="w-full md:w-auto px-16"
                        id="submit-btn"
                        data-submitting-text={t.submitting}
                    >
                        {t.submitButton}
                    </Button>
                </div>

                <p id="form-feedback" class="text-center mt-4 hidden"></p>
            </form>
        </Reveal>
    </div>
</section>

<script>
    function initContactForm() {
        const form = document.getElementById("contact-form") as HTMLFormElement;
        const feedback = document.getElementById("form-feedback");
        const submitBtn = document.getElementById("submit-btn");

        if (!form || !feedback || !submitBtn) return;

        // Record timestamp when form loads (anti-spam)
        const loadTimestamp = Date.now();

        const originalBtnText = submitBtn.textContent;
        const submittingText = submitBtn.getAttribute("data-submitting-text");

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            // Reset feedback
            feedback.classList.remove(
                "text-green-500",
                "text-red-500",
                "hidden",
            );
            feedback.textContent = "";

            // Set loading state
            submitBtn.setAttribute("disabled", "true");
            submitBtn.textContent = submittingText;

            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            // Add anti-spam timestamp
            (data as any)._timestamp = loadTimestamp.toString();

            try {
                const response = await fetch("/api/send-email", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (response.ok) {
                    feedback.textContent = "¡Mensaje enviado con éxito!";
                    feedback.classList.add("text-green-500");
                    form.reset();
                } else {
                    throw new Error(result.error || "Error");
                }
            } catch (err) {
                feedback.textContent =
                    "Ocurrió un error. Por favor, inténtalo de nuevo.";
                feedback.classList.add("text-red-500");
            } finally {
                submitBtn.removeAttribute("disabled");
                submitBtn.textContent = originalBtnText;
            }
        });
    }

    document.addEventListener("astro:page-load", initContactForm);
</script>
